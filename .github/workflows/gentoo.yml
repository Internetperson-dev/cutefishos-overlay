name: Gentoo overlay build test

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/internetperson-dev/gentoo-llvm-ci:latest

    steps:
      - name: Sync Portage
        run: |
          emaint sync -a

      - name: Configure Portage for CI
        run: |
          mkdir -p /etc/portage/package.use/ci
          mkdir -p /etc/portage/package.accept_keywords
          mkdir -p /etc/portage/package.mask

          echo 'FEATURES="${FEATURES}"' >> /etc/portage/make.conf
          echo 'ACCEPT_LICENSE="*"' >> /etc/portage/make.conf

      - name: Add Cutefish overlay
        run: |
          eselect repository add cutefishos git \
            https://github.com/Internetperson-dev/cutefishos-overlay
          emaint sync -r cutefishos

      - name: Select Gentoo profile
        run: |
          eselect profile set 3

      - name: Accept keywords
        run: |
          cat <<EOF > /etc/portage/package.accept_keywords/cutefishos
          sys-libs/libcutefish **
          sys-libs/fishui **
          sys-libs/cutefish-core **
          cutefish-base/* **
          dev-util/ninja **
          EOF

      - name: Mask fragile packages
        run: |
          echo "cutefish-base/cutefish-kwin-plugins" \
            > /etc/portage/package.mask/cutefishos

      - name: Build Cutefish core (NO LLVM BUILDS)
        run: |
          emerge -v --jobs=1 --load-average=1 \
            sys-libs/libcutefish \
            sys-libs/fishui \
            sys-libs/cutefish-core

