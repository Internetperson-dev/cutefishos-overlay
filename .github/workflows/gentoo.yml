name: Gentoo overlay build test (binary-first, systemd)

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Install basic dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget xz-utils sudo

      - name: Download latest Gentoo stage3 (systemd)
        run: |
          set -euo pipefail
          META_URL="https://distfiles.gentoo.org/releases/amd64/autobuilds/current-stage3-amd64-systemd/latest-stage3-amd64-systemd.txt"
          wget -O latest.txt "${META_URL}"
          STAGE3_LINE=$(grep '^stage3-.*\.tar\.xz' latest.txt)
          STAGE3_TARBALL=$(echo "${STAGE3_LINE}" | awk '{print $1}')
          STAGE3_DATE=$(echo "${STAGE3_TARBALL}" | sed -E 's/.*-([0-9TZ]+)\.tar\.xz/\1/')
          STAGE3_URL="https://distfiles.gentoo.org/releases/amd64/autobuilds/${STAGE3_DATE}/${STAGE3_TARBALL}"
          echo "Using stage3 tarball: ${STAGE3_TARBALL}"
          wget -O stage3.tar.xz "${STAGE3_URL}"

          sudo mkdir -p /gentoo
          sudo tar xpf stage3.tar.xz \
            -C /gentoo \
            --xattrs-include='*.*' \
            --numeric-owner

      - name: Prepare chroot mounts
        run: |
          sudo mount --bind /dev  /gentoo/dev
          sudo mount --bind /proc /gentoo/proc
          sudo mount --bind /sys  /gentoo/sys
          sudo mount --bind /run  /gentoo/run

      - name: Configure DNS for chroot
        run: |
          sudo cp --dereference /etc/resolv.conf /gentoo/etc/resolv.conf

      - name: Configure Portage (binary-first)
        run: |
          sudo tee /gentoo/etc/portage/make.conf <<'EOF'
          COMMON_FLAGS="-O2 -pipe"
          CFLAGS="${COMMON_FLAGS}"
          CXXFLAGS="${COMMON_FLAGS}"

          FEATURES="getbinpkg binpkg-request-signature -sandbox -ipc-sandbox -pid-sandbox -network-sandbox"
          EMERGE_DEFAULT_OPTS="--usepkg --binpkg-respect-use=y --with-bdeps=y --jobs=2 --load-average=2"
          PORTAGE_BINHOST="https://distfiles.gentoo.org/packages/"
          ACCEPT_LICENSE="*"
          EOF

      - name: Block live ebuilds
        run: |
          sudo mkdir -p /gentoo/etc/portage/package.mask
          sudo tee /gentoo/etc/portage/package.mask/no-live <<'EOF'
          */*-9999
          EOF

      - name: Sync Portage and select systemd profile
        run: |
          sudo chroot /gentoo /bin/bash -c "
            source /etc/profile &&
            emerge-webrsync &&
            eselect profile set default/linux/amd64/23.0/systemd
          "

      - name: Install base tooling
        run: |
          sudo chroot /gentoo /bin/bash -c "
            source /etc/profile &&
            emerge --oneshot app-eselect/eselect-repository dev-vcs/git
          "

      - name: Add Cutefish overlay
        run: |
          sudo chroot /gentoo /bin/bash -c "
          source /etc/profile &&
          emerge -avuDN --quiet-build=y --nospinner \
          sys-libs/libcutefish sys-libs/fishui sys-libs/cutefish-core || true
          "

      - name: Accept keywords for Cutefish
        run: |
          sudo mkdir -p /gentoo/etc/portage/package.accept_keywords
          sudo tee /gentoo/etc/portage/package.accept_keywords/cutefishos <<'EOF'
          sys-libs/libcutefish ~amd64
          sys-libs/fishui ~amd64
          sys-libs/cutefish-core ~amd64
          cutefish-base/* ~amd64
          dev-util/ninja ~amd64
          EOF

      - name: Pin required USE flags (CI-stable)
        run: |
          sudo mkdir -p /gentoo/etc/portage/package.use
          sudo tee /gentoo/etc/portage/package.use/cutefish <<'EOF'
          # Qt / KDE requirements
          dev-qt/qtbase icu

          # Graphics stack
          media-libs/freetype harfbuzz png

          # Audio (REQUIRED_USE safe)
          media-libs/libcanberra alsa pulseaudio udev

          # systemd integration
          sys-apps/systemd policykit
          EOF

      - name: Install Cutefish binaries (non-interactive)
        run: |
          sudo chroot /gentoo /bin/bash -c "
            source /etc/profile &&
            emerge -vDN --quiet-build=y --nospinner \
              --autounmask-write \
              sys-libs/libcutefish sys-libs/fishui sys-libs/cutefish-core || true
          "
