name: Gentoo CI (no docker, mirrors + cache)

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      GENTOO_ROOT: /gentoo
      STAGE3_MIRROR: https://distfiles.gentoo.org/releases/amd64/autobuilds
      BINHOST: https://distfiles.gentoo.org/packages/

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install host dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git wget curl tar xz-utils bzip2 ca-certificates

      # ------------------------------
      # Cache stage3 + binpkgs
      # ------------------------------
      - name: Restore Gentoo cache
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/gentoo
            /gentoo/var/cache/binpkgs
          key: gentoo-cache-${{ runner.os }}

      # ------------------------------
      # Download latest stage3 (mirror-safe)
      # ------------------------------
      - name: Download latest Gentoo stage3
        run: |
          set -e

          mkdir -p /var/cache/gentoo
          cd /var/cache/gentoo

          echo "Fetching latest stage3 filenameâ€¦"
          STAGE3=$(curl -fsSL \
            ${STAGE3_MIRROR}/current-stage3-amd64/latest-stage3-amd64.txt \
            | awk 'NR==1 {print $1}')

          echo "Latest stage3 is: $STAGE3"

          if [ ! -f "${STAGE3##*/}" ]; then
            wget -O stage3.tar.xz \
              ${STAGE3_MIRROR}/$STAGE3
          else
            echo "Stage3 already cached"
          fi

          sudo mkdir -p $GENTOO_ROOT
          sudo tar xpf stage3.tar.xz -C $GENTOO_ROOT

      # ------------------------------
      # Mount chroot filesystems
      # ------------------------------
      - name: Mount Gentoo filesystems
        run: |
          sudo mount --types proc /proc $GENTOO_ROOT/proc
          sudo mount --rbind /sys $GENTOO_ROOT/sys
          sudo mount --make-rslave $GENTOO_ROOT/sys
          sudo mount --rbind /dev $GENTOO_ROOT/dev
          sudo mount --make-rslave $GENTOO_ROOT/dev

      # ------------------------------
      # Configure Portage (binary-only)
      # ------------------------------
      - name: Configure Portage
        run: |
          sudo tee $GENTOO_ROOT/etc/portage/make.conf <<'EOF'
          ACCEPT_LICENSE="*"
          FEATURES="getbinpkg binpkg-request-signature -sandbox -pid-sandbox -ipc-sandbox"
          PORTAGE_BINHOST="https://distfiles.gentoo.org/packages/"
          EMERGE_DEFAULT_OPTS="--usepkgonly --getbinpkg"
          MAKEOPTS="-j2"
          EOF

      # ------------------------------
      # Sync Portage
      # ------------------------------
      - name: Sync Portage tree
        run: |
          sudo chroot $GENTOO_ROOT emerge-webrsync

      # ------------------------------
      # Install base tooling (binary only)
      # ------------------------------
      - name: Install base tools
        run: |
          sudo chroot $GENTOO_ROOT emerge -K \
            app-eselect/eselect-repository \
            app-portage/gentoolkit \
            dev-vcs/git

      # ------------------------------
      # HARD BLOCK SOURCE LLVM
      # ------------------------------
      - name: Mask source LLVM (safety)
        run: |
          sudo mkdir -p $GENTOO_ROOT/etc/portage/package.mask/ci
          sudo tee $GENTOO_ROOT/etc/portage/package.mask/ci/llvm <<'EOF'
          llvm-core/llvm
          llvm-core/clang
          llvm-core/lld
          EOF

      - name: Install LLVM (binary only)
        run: |
          sudo chroot $GENTOO_ROOT emerge -K \
            llvm-core/llvm \
            llvm-core/clang \
            llvm-core/lld

      # ------------------------------
      # Add Cutefish overlay
      # ------------------------------
      - name: Add Cutefish overlay
        run: |
          sudo chroot $GENTOO_ROOT eselect repository add cutefishos git \
            https://github.com/Internetperson-dev/cutefishos-overlay
          sudo chroot $GENTOO_ROOT emaint sync -r cutefishos

      - name: Select Gentoo profile
        run: |
          sudo chroot $GENTOO_ROOT eselect profile set 3

      - name: Accept Cutefish keywords
        run: |
          sudo mkdir -p $GENTOO_ROOT/etc/portage/package.accept_keywords
          sudo tee $GENTOO_ROOT/etc/portage/package.accept_keywords/cutefishos <<'EOF'
          sys-libs/libcutefish **
          sys-libs/fishui **
          sys-libs/cutefish-core **
          cutefish-base/* **
          EOF

      - name: Mask fragile packages
        run: |
          sudo mkdir -p $GENTOO_ROOT/etc/portage/package.mask
          echo "cutefish-base/cutefish-kwin-plugins" | \
            sudo tee $GENTOO_ROOT/etc/portage/package.mask/cutefishos

      # ------------------------------
      # Build Cutefish
      # ------------------------------
      - name: Build Cutefish core
        run: |
          sudo chroot $GENTOO_ROOT emerge -v \
            sys-libs/libcutefish \
            sys-libs/fishui \
            sys-libs/cutefish-core
