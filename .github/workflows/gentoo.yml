name: Gentoo overlay build test (binary-first)

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: gentoo/stage3:latest

    steps:
      - name: Sync Portage
        run: |
          emerge-webrsync

      - name: Configure Portage for CI (binary-first)
        run: |
          set -e

          mkdir -p /etc/portage/package.use/ci
          mkdir -p /etc/portage/package.accept_keywords
          mkdir -p /etc/portage/package.mask
          mkdir -p /etc/portage/binrepos.conf

          # GitHub Actions kernel limitations
          echo 'FEATURES="-ipc-sandbox -network-sandbox -pid-sandbox"' >> /etc/portage/make.conf

          # Enable ccache + binpkgs
          echo 'FEATURES="${FEATURES} ccache getbinpkg binpkg-request-signature"' >> /etc/portage/make.conf
          echo 'EMERGE_DEFAULT_OPTS="--usepkg --getbinpkg --binpkg-respect-use=y --jobs=2 --load-average=2"' >> /etc/portage/make.conf

          # Official Gentoo binary repo
          cat <<EOF > /etc/portage/binrepos.conf/gentoo.conf
          [gentoo]
          priority = 9999
          sync-uri = https://distfiles.gentoo.org/packages
          EOF

          echo 'PORTAGE_BINHOST="https://distfiles.gentoo.org/packages"' >> /etc/portage/make.conf
          echo 'ACCEPT_LICENSE="*"' >> /etc/portage/make.conf

          # Break known circular deps
          echo "media-libs/tiff -webp" > /etc/portage/package.use/ci/tiff
          echo "dev-python/pillow -truetype" > /etc/portage/package.use/ci/pillow

      - name: Install base tooling (binary-only)
        run: |
          emerge -v --usepkgonly \
            app-eselect/eselect-repository \
            app-portage/gentoolkit \
            dev-vcs/git

      - name: Add Cutefish overlay
        run: |
          eselect repository add cutefishos git \
            https://github.com/Internetperson-dev/cutefishos-overlay
          emaint sync -r cutefishos

      - name: Select Gentoo profile
        run: |
          eselect profile set 3

      - name: Accept keywords
        run: |
          cat <<EOF > /etc/portage/package.accept_keywords/cutefishos
          sys-libs/libcutefish **
          sys-libs/fishui **
          sys-libs/cutefish-core **
          cutefish-base/* **
          dev-util/ninja **
          EOF

      - name: Mask fragile packages
        run: |
          echo "cutefish-base/cutefish-kwin-plugins" > /etc/portage/package.mask/cutefishos

      - name: Install build tools (prefer binaries)
        run: |
          emerge -v dev-build/ninja dev-build/cmake

      - name: Build Cutefish core (binary-first, fail fast)
        run: |
          emerge -v \
            --usepkg \
            --getbinpkg \
            --binpkg-respect-use=y \
            --jobs=1 \
            --load-average=1 \
            sys-libs/libcutefish \
            sys-libs/fishui \
            sys-libs/cutefish-core
