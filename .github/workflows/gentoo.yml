name: Cutefish CI Build

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:   # <-- This enables the "Run workflow" button

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl python3 python3-pip xz-utils sudo

      - name: Bootstrap Gentoo Prefix
        run: |
          curl -L https://gitweb.gentoo.org/repo/proj/prefix.git/plain/scripts/bootstrap-prefix.sh -o bootstrap-prefix.sh
          chmod +x bootstrap-prefix.sh
          ./bootstrap-prefix.sh ~/gentoo

      - name: Set Gentoo environment
        run: |
          source ~/gentoo/etc/profile.env
          export PATH=~/gentoo/usr/bin:$PATH

      - name: Break circular dependencies
        run: |
          mkdir -p ~/gentoo/etc/portage/package.use/cutefish
          echo "media-libs/libwebp -tiff" >> ~/gentoo/etc/portage/package.use/cutefish/libwebp
          echo "media-libs/tiff -webp" >> ~/gentoo/etc/portage/package.use/cutefish/tiff

      - name: Sync Portage tree
        run: |
          emerge --sync

      - name: Update world
        run: |
          emerge -uDN @world

      - name: Install Cutefish dependencies
        run: |
          emerge -v \
            dev-libs/glib \
            sys-libs/udisks \
            sys-auth/polkit \
            media-libs/libwebp \
            media-libs/tiff \
            x11-libs/gtk+ \
            dev-qt/qtbase \
            dev-qt/qttools \
            kde-frameworks/kio \
            kde-frameworks/kcoreaddons \
            kde-frameworks/kwindowsystem

      - name: Build Cutefish
        run: |
          cd $GITHUB_WORKSPACE
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)

      - name: Run tests
        run: |
          cd $GITHUB_WORKSPACE/build
          ctest --output-on-failure
